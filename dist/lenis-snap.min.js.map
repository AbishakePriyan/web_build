{"version":3,"file":"lenis-snap.min.js","sources":["../src/slide.js","../src/uid.ts","../src/index.ts"],"sourcesContent":["function removeParentSticky(element) {\r\n  const position = getComputedStyle(element).position\r\n\r\n  const isSticky = position === 'sticky'\r\n\r\n  if (isSticky) {\r\n    element.style.setProperty('position', 'static')\r\n    element.dataset.sticky = 'true'\r\n  }\r\n\r\n  if (element.offsetParent) {\r\n    removeParentSticky(element.offsetParent)\r\n  }\r\n}\r\n\r\nfunction addParentSticky(element) {\r\n  if (element?.dataset?.sticky === 'true') {\r\n    element.style.removeProperty('position')\r\n    delete element.dataset.sticky\r\n  }\r\n\r\n  if (element.offsetParent) {\r\n    addParentSticky(element.offsetParent)\r\n  }\r\n}\r\n\r\nfunction offsetTop(element, accumulator = 0) {\r\n  const top = accumulator + element.offsetTop\r\n  if (element.offsetParent) {\r\n    return offsetTop(element.offsetParent, top)\r\n  }\r\n  return top\r\n}\r\n\r\nfunction offsetLeft(element, accumulator = 0) {\r\n  const left = accumulator + element.offsetLeft\r\n  if (element.offsetParent) {\r\n    return offsetLeft(element.offsetParent, left)\r\n  }\r\n  return left\r\n}\r\n\r\nfunction scrollTop(element, accumulator = 0) {\r\n  const top = accumulator + element.scrollTop\r\n  if (element.offsetParent) {\r\n    return scrollTop(element.offsetParent, top)\r\n  }\r\n  return top + window.scrollY\r\n}\r\n\r\nfunction scrollLeft(element, accumulator = 0) {\r\n  const left = accumulator + element.scrollLeft\r\n  if (element.offsetParent) {\r\n    return scrollLeft(element.offsetParent, left)\r\n  }\r\n  return left + window.scrollX\r\n}\r\n\r\nexport default class Slide {\r\n  constructor(\r\n    element,\r\n    { align = ['start'], ignoreSticky = true, ignoreTransform = false } = {},\r\n  ) {\r\n    this.element = element\r\n\r\n    this.ignoreSticky = ignoreSticky\r\n    this.ignoreTransform = ignoreTransform\r\n\r\n    this.align = [align].flat()\r\n\r\n    this.rect = {}\r\n\r\n    this.wrapperResizeObserver = new ResizeObserver(this.onWrapperResize)\r\n    this.wrapperResizeObserver.observe(document.body)\r\n\r\n    this.resizeObserver = new ResizeObserver(this.onResize)\r\n    this.resizeObserver.observe(this.element)\r\n  }\r\n\r\n  destroy() {\r\n    this.wrapperResizeObserver.disconnect()\r\n    this.resizeObserver.disconnect()\r\n  }\r\n\r\n  setRect({ top, left, width, height, element }) {\r\n    top = top ?? this.rect.top\r\n    left = left ?? this.rect.left\r\n    width = width ?? this.rect.width\r\n    height = height ?? this.rect.height\r\n    element = element ?? this.rect.element\r\n\r\n    if (\r\n      top === this.rect.top &&\r\n      left === this.rect.left &&\r\n      width === this.rect.width &&\r\n      height === this.rect.height &&\r\n      element === this.rect.element\r\n    )\r\n      return\r\n\r\n    this.rect.top = top\r\n    this.rect.y = top\r\n    this.rect.width = width\r\n    this.rect.height = height\r\n    this.rect.left = left\r\n    this.rect.x = left\r\n    this.rect.bottom = top + height\r\n    this.rect.right = left + width\r\n  }\r\n\r\n  onWrapperResize = () => {\r\n    let top, left\r\n\r\n    if (this.ignoreSticky) removeParentSticky(this.element)\r\n    if (this.ignoreTransform) {\r\n      top = offsetTop(this.element)\r\n      left = offsetLeft(this.element)\r\n    } else {\r\n      const rect = this.element.getBoundingClientRect()\r\n      top = rect.top + scrollTop(this.element)\r\n      left = rect.left + scrollLeft(this.element)\r\n    }\r\n    if (this.ignoreSticky) addParentSticky(this.element)\r\n\r\n    this.setRect({ top, left })\r\n  }\r\n\r\n  onResize = ([entry]) => {\r\n    const width = entry.borderBoxSize[0].inlineSize\r\n    const height = entry.borderBoxSize[0].blockSize\r\n\r\n    this.setRect({ width, height })\r\n  }\r\n}\r\n","let index = 0\r\n\r\nexport type UID = number\r\n\r\nexport function uid(): UID {\r\n  return index++\r\n}\r\n","import Lenis from 'lenis'\r\nimport Slide from './slide'\r\nimport { uid, UID } from './uid'\r\n\r\n// TODO:\r\n// - horizontal\r\n// - fix trackpad snapping too soon due to velocity (fuck Apple)\r\n// - fix wheel scrolling after limits (see console scroll to)\r\n// - fix touch scroll, do not snap when not released\r\n\r\ntype Viewport = {\r\n  width: number\r\n  height: number\r\n}\r\n\r\nexport type SnapOptions = {\r\n  type?: 'mandatory' | 'proximity'\r\n  lerp?: number\r\n  easing?: (t: number) => number\r\n  duration?: number\r\n  velocityThreshold?: number\r\n  onSnapStart?: (t: number) => number\r\n  onSnapComplete?: (t: number) => number\r\n}\r\n\r\nexport default class Snap {\r\n  lenis: Lenis\r\n  options: SnapOptions\r\n  elements: Map<number, Node>\r\n  snaps: Map<number, number>\r\n  viewport: Viewport\r\n  isStopped: Boolean = false\r\n\r\n  constructor(\r\n    lenis: Lenis,\r\n    {\r\n      type = 'mandatory',\r\n      lerp,\r\n      easing,\r\n      duration,\r\n      velocityThreshold = 1,\r\n      onSnapStart,\r\n      onSnapComplete,\r\n    }: SnapOptions = {},\r\n  ) {\r\n    this.lenis = lenis\r\n\r\n    this.options = {\r\n      type,\r\n      lerp,\r\n      easing,\r\n      duration,\r\n      velocityThreshold,\r\n      onSnapStart,\r\n      onSnapComplete,\r\n    }\r\n\r\n    this.elements = new Map()\r\n    this.snaps = new Map()\r\n\r\n    this.viewport = {\r\n      width: window.innerWidth,\r\n      height: window.innerHeight,\r\n    }\r\n    this.onWindowResize()\r\n    window.addEventListener('resize', this.onWindowResize)\r\n\r\n    this.lenis.on('scroll', this.onScroll)\r\n  }\r\n\r\n  // debug() {\r\n  //   const element = document.createElement('div')\r\n  //   element.style.cssText = `\r\n  //     position: fixed;\r\n  //     background: red;\r\n  //     border-bottom: 1px solid red;\r\n  //     left: 0;\r\n  //     right: 0;\r\n  //     top: 0;\r\n  //     z-index: 9999;\r\n  //   `\r\n  //   document.body.appendChild(element)\r\n  // }\r\n\r\n  destroy() {\r\n    this.lenis.off('scroll', this.onScroll)\r\n    window.removeEventListener('resize', this.onWindowResize)\r\n    this.elements.forEach((slide) => slide.destroy())\r\n  }\r\n\r\n  start() {\r\n    this.isStopped = false\r\n  }\r\n\r\n  stop() {\r\n    this.isStopped = true\r\n  }\r\n\r\n  add(value: number) {\r\n    const id = uid()\r\n\r\n    this.snaps.set(id, value)\r\n\r\n    return () => this.remove(id)\r\n  }\r\n\r\n  remove(id: UID) {\r\n    this.snaps.delete(id)\r\n  }\r\n\r\n  addElement(element: Node, options = {}) {\r\n    const id = uid()\r\n\r\n    this.elements.set(id, new Slide(element, options))\r\n\r\n    return () => this.removeElement(id)\r\n  }\r\n\r\n  removeElement(id: UID) {\r\n    this.elements.delete(id)\r\n  }\r\n\r\n  onWindowResize = () => {\r\n    this.viewport.width = window.innerWidth\r\n    this.viewport.height = window.innerHeight\r\n  }\r\n\r\n  onScroll = ({\r\n    scroll,\r\n    limit,\r\n    lastVelocity,\r\n    velocity,\r\n    isScrolling,\r\n    userData,\r\n    isHorizontal,\r\n  }) => {\r\n    if (this.isStopped) return\r\n    // console.log(scroll, velocity, type)\r\n\r\n    // return\r\n    const isDecelerating = Math.abs(lastVelocity) > Math.abs(velocity)\r\n    const isTurningBack =\r\n      Math.sign(lastVelocity) !== Math.sign(velocity) && velocity !== 0\r\n\r\n    // console.log({ lastVelocity, velocity, isTurningBack, isDecelerating })\r\n\r\n    // console.log('onScroll')\r\n\r\n    if (\r\n      Math.abs(velocity) < this.options.velocityThreshold &&\r\n      // !isTouching &&\r\n      isDecelerating &&\r\n      !isTurningBack &&\r\n      userData?.initiator !== 'snap'\r\n    ) {\r\n      scroll = Math.ceil(scroll)\r\n\r\n      let snaps = [0, ...this.snaps.values(), limit] as number[]\r\n\r\n      this.elements.forEach(({ rect, align }) => {\r\n        let snap\r\n\r\n        align.forEach((align) => {\r\n          if (align === 'start') {\r\n            snap = rect.top\r\n          } else if (align === 'center') {\r\n            snap = rect.top + rect.height / 2 - this.viewport.height / 2\r\n          } else if (align === 'end') {\r\n            snap = rect.top + rect.height - this.viewport.height\r\n          }\r\n\r\n          if (snap !== undefined) {\r\n            snaps.push(Math.ceil(snap))\r\n          }\r\n        })\r\n      })\r\n\r\n      snaps = snaps.sort((a, b) => Math.abs(a) - Math.abs(b))\r\n\r\n      let prevSnap = snaps.findLast((snap) => snap <= scroll)\r\n      if (prevSnap === undefined) prevSnap = snaps[0]\r\n      const distanceToPrevSnap = Math.abs(scroll - prevSnap)\r\n\r\n      let nextSnap = snaps.find((snap) => snap >= scroll)\r\n      if (nextSnap === undefined) nextSnap = snaps[snaps.length - 1]\r\n      const distanceToNextSnap = Math.abs(scroll - nextSnap)\r\n\r\n      const snap = distanceToPrevSnap < distanceToNextSnap ? prevSnap : nextSnap\r\n\r\n      const distance = Math.abs(scroll - snap)\r\n\r\n      if (\r\n        this.options.type === 'mandatory' ||\r\n        (this.options.type === 'proximity' && distance <= this.viewport.height)\r\n      ) {\r\n        // this.__isScrolling = true\r\n        // this.onSnapStart?.(snap)\r\n\r\n        // console.log('scroll to')\r\n\r\n        this.lenis.scrollTo(snap, {\r\n          lerp: this.options.lerp,\r\n          easing: this.options.easing,\r\n          duration: this.options.duration,\r\n          userData: { initiator: 'snap' },\r\n          onStart: () => {\r\n            this.options.onSnapStart?.(snap)\r\n          },\r\n          onComplete: () => {\r\n            this.options.onSnapComplete?.(snap)\r\n          },\r\n        })\r\n      }\r\n\r\n      // console.timeEnd('scroll')\r\n    }\r\n  }\r\n}\r\n"],"names":["removeParentSticky","element","getComputedStyle","position","style","setProperty","dataset","sticky","offsetParent","addParentSticky","removeProperty","offsetTop","accumulator","top","offsetLeft","left","scrollTop","window","scrollY","scrollLeft","scrollX","Slide","constructor","align","ignoreSticky","ignoreTransform","this","flat","rect","wrapperResizeObserver","ResizeObserver","onWrapperResize","observe","document","body","resizeObserver","onResize","destroy","disconnect","setRect","width","height","y","x","bottom","right","getBoundingClientRect","entry","borderBoxSize","inlineSize","blockSize","index","uid","Snap","lenis","type","lerp","easing","duration","velocityThreshold","onSnapStart","onSnapComplete","isStopped","onWindowResize","viewport","innerWidth","innerHeight","onScroll","scroll","limit","lastVelocity","velocity","isScrolling","userData","isHorizontal","isDecelerating","Math","abs","isTurningBack","sign","options","initiator","ceil","snaps","values","elements","forEach","snap","undefined","push","sort","a","b","prevSnap","findLast","distanceToPrevSnap","nextSnap","find","length","distance","scrollTo","onStart","_b","_a","call","onComplete","Map","addEventListener","on","off","removeEventListener","slide","start","stop","add","value","id","set","remove","delete","addElement","removeElement"],"mappings":"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"}