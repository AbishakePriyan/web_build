{"version":3,"file":"lenis-snap.min.js","sources":["../src/slide.js","../src/index.ts"],"sourcesContent":["function removeParentSticky(element) {\r\n  const position = getComputedStyle(element).position\r\n\r\n  const isSticky = position === 'sticky'\r\n\r\n  if (isSticky) {\r\n    element.style.setProperty('position', 'static')\r\n    element.dataset.sticky = 'true'\r\n  }\r\n\r\n  if (element.offsetParent) {\r\n    removeParentSticky(element.offsetParent)\r\n  }\r\n}\r\n\r\nfunction addParentSticky(element) {\r\n  if (element?.dataset?.sticky === 'true') {\r\n    element.style.removeProperty('position')\r\n    delete element.dataset.sticky\r\n  }\r\n\r\n  if (element.offsetParent) {\r\n    addParentSticky(element.offsetParent)\r\n  }\r\n}\r\n\r\nfunction offsetTop(element, accumulator = 0) {\r\n  const top = accumulator + element.offsetTop\r\n  if (element.offsetParent) {\r\n    return offsetTop(element.offsetParent, top)\r\n  }\r\n  return top\r\n}\r\n\r\nfunction offsetLeft(element, accumulator = 0) {\r\n  const left = accumulator + element.offsetLeft\r\n  if (element.offsetParent) {\r\n    return offsetLeft(element.offsetParent, left)\r\n  }\r\n  return left\r\n}\r\n\r\nfunction scrollTop(element, accumulator = 0) {\r\n  const top = accumulator + element.scrollTop\r\n  if (element.offsetParent) {\r\n    return scrollTop(element.offsetParent, top)\r\n  }\r\n  return top + window.scrollY\r\n}\r\n\r\nfunction scrollLeft(element, accumulator = 0) {\r\n  const left = accumulator + element.scrollLeft\r\n  if (element.offsetParent) {\r\n    return scrollLeft(element.offsetParent, left)\r\n  }\r\n  return left + window.scrollX\r\n}\r\n\r\nexport default class Slide {\r\n  constructor(\r\n    element,\r\n    { align = ['start'], ignoreSticky = true, ignoreTransform = false } = {}\r\n  ) {\r\n    this.element = element\r\n\r\n    this.ignoreSticky = ignoreSticky\r\n    this.ignoreTransform = ignoreTransform\r\n\r\n    this.align = [align].flat()\r\n\r\n    this.rect = {}\r\n\r\n    this.wrapperResizeObserver = new ResizeObserver(this.onWrapperResize)\r\n    this.wrapperResizeObserver.observe(document.body)\r\n\r\n    this.resizeObserver = new ResizeObserver(this.onResize)\r\n    this.resizeObserver.observe(this.element)\r\n  }\r\n\r\n  destroy() {\r\n    this.wrapperResizeObserver.disconnect()\r\n    this.resizeObserver.disconnect()\r\n  }\r\n\r\n  setRect({ top, left, width, height, element }) {\r\n    top = top ?? this.rect.top\r\n    left = left ?? this.rect.left\r\n    width = width ?? this.rect.width\r\n    height = height ?? this.rect.height\r\n    element = element ?? this.rect.element\r\n\r\n    if (\r\n      top === this.rect.top &&\r\n      left === this.rect.left &&\r\n      width === this.rect.width &&\r\n      height === this.rect.height &&\r\n      element === this.rect.element\r\n    )\r\n      return\r\n\r\n    this.rect.top = top\r\n    this.rect.y = top\r\n    this.rect.width = width\r\n    this.rect.height = height\r\n    this.rect.left = left\r\n    this.rect.x = left\r\n    this.rect.bottom = top + height\r\n    this.rect.right = left + width\r\n  }\r\n\r\n  onWrapperResize = () => {\r\n    let top, left\r\n\r\n    if (this.ignoreSticky) removeParentSticky(this.element)\r\n    if (this.ignoreTransform) {\r\n      top = offsetTop(this.element)\r\n      left = offsetLeft(this.element)\r\n    } else {\r\n      const rect = this.element.getBoundingClientRect()\r\n      top = rect.top + scrollTop(this.element)\r\n      left = rect.left + scrollLeft(this.element)\r\n    }\r\n    if (this.ignoreSticky) addParentSticky(this.element)\r\n\r\n    this.setRect({ top, left })\r\n  }\r\n\r\n  onResize = ([entry]) => {\r\n    const width = entry.borderBoxSize[0].inlineSize\r\n    const height = entry.borderBoxSize[0].blockSize\r\n\r\n    this.setRect({ width, height })\r\n  }\r\n}\r\n","import Slide from './slide'\r\n\r\n// TODO:\r\n// - horizontal\r\n// - fix trackpad snapping too soon due to velocity (fuck Apple)\r\n// - fix wheel scrolling after limits (see console scroll to)\r\n// - fix touch scroll, do not snap when not released\r\n\r\nconsole.log('snaps')\r\n\r\nexport default class Snap {\r\n  constructor(\r\n    lenis,\r\n    {\r\n      type = 'mandatory',\r\n      velocityThreshold = 1,\r\n      onSnapStart,\r\n      onSnapComplete,\r\n    } = {}\r\n  ) {\r\n    this.lenis = lenis\r\n    this.type = type\r\n    this.elements = new Map()\r\n    this.snaps = new Map()\r\n\r\n    this.velocityThreshold = velocityThreshold\r\n    this.onSnapStart = onSnapStart\r\n    this.onSnapComplete = onSnapComplete\r\n\r\n    this.viewport = {\r\n      width: window.innerWidth,\r\n      height: window.innerHeight,\r\n    }\r\n    this.onWindowResize()\r\n    window.addEventListener('resize', this.onWindowResize)\r\n\r\n    this.lenis.on('scroll', this.onScroll)\r\n  }\r\n\r\n  // debug() {\r\n  //   const element = document.createElement('div')\r\n  //   element.style.cssText = `\r\n  //     position: fixed;\r\n  //     background: red;\r\n  //     border-bottom: 1px solid red;\r\n  //     left: 0;\r\n  //     right: 0;\r\n  //     top: 0;\r\n  //     z-index: 9999;\r\n  //   `\r\n  //   document.body.appendChild(element)\r\n  // }\r\n\r\n  destroy() {\r\n    this.lenis.off('scroll', this.onScroll)\r\n    window.removeEventListener('resize', this.onWindowResize)\r\n    this.elements.forEach((slide) => slide.destroy())\r\n  }\r\n\r\n  add(value) {\r\n    const id = crypto.randomUUID()\r\n\r\n    this.snaps.set(id, value)\r\n\r\n    return () => this.remove(id)\r\n  }\r\n\r\n  remove(id) {\r\n    this.snaps.delete(id)\r\n  }\r\n\r\n  addElement(element, options = {}) {\r\n    const id = crypto.randomUUID()\r\n\r\n    this.elements.set(id, new Slide(element, options))\r\n\r\n    return () => this.removeElement(id)\r\n  }\r\n\r\n  removeElement(id) {\r\n    this.elements.delete(id)\r\n  }\r\n\r\n  onWindowResize = () => {\r\n    this.viewport.width = window.innerWidth\r\n    this.viewport.height = window.innerHeight\r\n  }\r\n\r\n  onScroll = (\r\n    { scroll, limit, lastVelocity, velocity, isScrolling, isTouching },\r\n    { userData, isSmooth, type }\r\n  ) => {\r\n    // console.log(scroll, velocity, type)\r\n\r\n    // return\r\n    const isDecelerating = Math.abs(lastVelocity) > Math.abs(velocity)\r\n    const isTurningBack =\r\n      Math.sign(lastVelocity) !== Math.sign(velocity) && velocity !== 0\r\n\r\n    // console.log({ lastVelocity, velocity, isTurningBack, isDecelerating })\r\n\r\n    // console.log('onScroll')\r\n\r\n    if (\r\n      Math.abs(velocity) < this.velocityThreshold &&\r\n      // !isTouching &&\r\n      isDecelerating &&\r\n      !isTurningBack &&\r\n      userData?.initiator !== 'snap'\r\n    ) {\r\n      scroll = Math.ceil(scroll)\r\n\r\n      // console.log('not scrolling anymore')\r\n\r\n      // console.log(\r\n      //   this.snaps,\r\n      //   Array.from(this.snaps, ([_, value]) => value),\r\n      //   'test'\r\n      // )\r\n\r\n      let snaps = [0, ...Array.from(this.snaps, ([_, value]) => value), limit]\r\n\r\n      // let snaps = [0, ...this.snaps.values(), limit]\r\n\r\n      console.log(snaps)\r\n\r\n      this.elements.forEach(({ rect, align }) => {\r\n        let snap\r\n\r\n        align.forEach((align) => {\r\n          if (align === 'start') {\r\n            snap = rect.top\r\n          } else if (align === 'center') {\r\n            snap = rect.top + rect.height / 2 - this.viewport.height / 2\r\n          } else if (align === 'end') {\r\n            snap = rect.top + rect.height - this.viewport.height\r\n          }\r\n\r\n          if (snap !== undefined) {\r\n            snaps.push(Math.ceil(snap))\r\n          }\r\n        })\r\n      })\r\n\r\n      snaps = snaps.sort((a, b) => Math.abs(a) - Math.abs(b))\r\n\r\n      let prevSnap = snaps.findLast((snap) => snap <= scroll)\r\n      if (prevSnap === undefined) prevSnap = snaps[0]\r\n      const distanceToPrevSnap = Math.abs(scroll - prevSnap)\r\n\r\n      let nextSnap = snaps.find((snap) => snap >= scroll)\r\n      if (nextSnap === undefined) nextSnap = snaps[snaps.length - 1]\r\n      const distanceToNextSnap = Math.abs(scroll - nextSnap)\r\n\r\n      const snap = distanceToPrevSnap < distanceToNextSnap ? prevSnap : nextSnap\r\n\r\n      const distance = Math.abs(scroll - snap)\r\n\r\n      if (\r\n        this.type === 'mandatory' ||\r\n        (this.type === 'proximity' && distance <= this.viewport.height)\r\n      ) {\r\n        // this.__isScrolling = true\r\n        // this.onSnapStart?.(snap)\r\n\r\n        // console.log('scroll to')\r\n\r\n        this.lenis.scrollTo(snap, {\r\n          userData: { initiator: 'snap' },\r\n          onStart: () => {\r\n            this.onSnapStart?.(snap)\r\n          },\r\n          onComplete: () => {\r\n            this.onSnapComplete?.(snap)\r\n          },\r\n        })\r\n      }\r\n\r\n      // console.timeEnd('scroll')\r\n    }\r\n  }\r\n}\r\n"],"names":["removeParentSticky","element","getComputedStyle","position","style","setProperty","dataset","sticky","offsetParent","addParentSticky","removeProperty","offsetTop","accumulator","top","offsetLeft","left","scrollTop","window","scrollY","scrollLeft","scrollX","Slide","constructor","align","ignoreSticky","ignoreTransform","this","flat","rect","wrapperResizeObserver","ResizeObserver","onWrapperResize","observe","document","body","resizeObserver","onResize","destroy","disconnect","setRect","width","height","y","x","bottom","right","getBoundingClientRect","entry","borderBoxSize","inlineSize","blockSize","console","log","Snap","lenis","type","velocityThreshold","onSnapStart","onSnapComplete","onWindowResize","viewport","innerWidth","innerHeight","onScroll","scroll","limit","lastVelocity","velocity","isScrolling","isTouching","userData","isSmooth","isDecelerating","Math","abs","isTurningBack","sign","initiator","ceil","snaps","Array","from","_","value","elements","forEach","snap","undefined","push","sort","a","b","prevSnap","findLast","distanceToPrevSnap","nextSnap","find","length","distance","scrollTo","onStart","_a","call","onComplete","Map","addEventListener","on","off","removeEventListener","slide","add","id","crypto","randomUUID","set","remove","delete","addElement","options","removeElement"],"mappings":"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"}